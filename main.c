#include <stdio.h>
#include <string.h>
#include "tcp_ip_stack.h"

void simulate_network_traffic() {
    uint8_t arp_request[] = {
        0x12, 0x34, 0x56, 0x78, 0x9a, 0xbc,
        0xaa, 0xbb, 0xcc, 0xdd, 0xee, 0xff,
        0x08, 0x06,
        0x00, 0x01, 0x08, 0x00, 0x06, 0x04, 0x00, 0x01,
        0xaa, 0xbb, 0xcc, 0xdd, 0xee, 0xff,
        0xc0, 0xa8, 0x01, 0x02,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0xc0, 0xa8, 0x01, 0x01
    };

    uint8_t icmp_request[] = {
        0x12, 0x34, 0x56, 0x78, 0x9a, 0xbc,
        0xaa, 0xbb, 0xcc, 0xdd, 0xee, 0xff,
        0x08, 0x00,
        0x45, 0x00, 0x00, 0x54, 0x12, 0x34, 0x00, 0x00,
        0x40, 0x01, 0x00, 0x00, 0xc0, 0xa8, 0x01, 0x02,
        0xc0, 0xa8, 0x01, 0x01,
        0x08, 0x00, 0x00, 0x00, 0x12, 0x34, 0x00, 0x01,
        'H', 'e', 'l', 'l', 'o', ',', ' ', 'T', 'C', 'P',
        '/', 'I', 'P', ' ', 'S', 't', 'a', 'c', 'k', '!'
    };

    uint8_t tcp_packet[] = {
        0x12, 0x34, 0x56, 0x78, 0x9a, 0xbc,
        0xaa, 0xbb, 0xcc, 0xdd, 0xee, 0xff,
        0x08, 0x00,
        0x45, 0x00, 0x00, 0x40, 0x12, 0x35, 0x00, 0x00,
        0x40, 0x06, 0x00, 0x00, 0xc0, 0xa8, 0x01, 0x02,
        0xc0, 0xa8, 0x01, 0x01,
        0x13, 0x88, 0x1F, 0x90, 0x00, 0x00, 0x00, 0x01,
        0x00, 0x00, 0x00, 0x00, 0x50, 0x02, 0x20, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        'T', 'C', 'P', ' ', 'T', 'e', 's', 't', ' ', 'D', 'a', 't', 'a'
    };

    printf("Testing ARP processing...\n");
    process_frame(arp_request, sizeof(arp_request));

    printf("\nTesting ICMP processing...\n");
    struct ip_header* ip = (struct ip_header*)(icmp_request + sizeof(struct eth_header));
    ip->checksum = 0;
    ip->checksum = calculate_checksum(ip, sizeof(struct ip_header));
    
    struct icmp_header* icmp = (struct icmp_header*)(icmp_request + sizeof(struct eth_header) + sizeof(struct ip_header));
    icmp->checksum = 0;
    icmp->checksum = calculate_checksum(icmp, sizeof(struct icmp_header) + 20);
    
    process_frame(icmp_request, sizeof(icmp_request));

    printf("\nTesting TCP processing...\n");
    ip = (struct ip_header*)(tcp_packet + sizeof(struct eth_header));
    ip->checksum = 0;
    ip->checksum = calculate_checksum(ip, sizeof(struct ip_header));
    
    process_frame(tcp_packet, sizeof(tcp_packet));
}

int main() {
    printf("TCP/IP Stack Implementation Test\n");
    printf("================================\n\n");

    network_init("192.168.1.1");

    printf("\nStarting network simulation...\n");
    simulate_network_traffic();

    printf("\nTest completed successfully!\n");
    return 0;
}